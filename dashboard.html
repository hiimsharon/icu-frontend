<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <link rel="stylesheet" href="style.css">
  <meta charset="UTF-8" />
  <title>ICU ç—…æ‚£æŸ¥è©¢</title>
  <footer>ICU Management System - Â© Sha Huang</footer>

  <style>
    body { font-family: sans-serif; padding: 0; margin: 0; }
    header { display: flex; justify-content: space-between; align-items: center; background: #f0f0f0; padding: 1em; }
    table { margin: 2em auto; border-collapse: collapse; width: 95%; }
    th, td { border: 1px solid #ccc; padding: 0.5em; }
    canvas { display: block; margin: 2em auto; }
    footer { margin-top: 2em; font-size: 0.8em; text-align: center; color: gray; }
    button.menu { margin-left: 1em; }
  </style>
</head>
<body>
  <header>
    <div><strong>ICU ç³»çµ±</strong> | <span id="now"></span></div>
    <div>
      é†«å¸«ï¼š<span id="doctor"></span>
      <button class="menu" onclick="window.location.href='form.html'">æ–°å¢è³‡æ–™</button>
      <button class="menu" onclick="logout()">ç™»å‡º</button>
    </div>
  </header>
  <table id="patientTable">
    <thead>
      <tr><th>å§“å</th><th>ç—…æ­·è™Ÿ</th><th>å¹´é½¡</th><th>æ€§åˆ¥</th><th>åºŠè™Ÿ</th><th>è¨ºæ–·</th><th>APACHE II</th></tr>
    </thead>
    <tbody></tbody>
  </table>
  <canvas id="chart" width="600" height="200"></canvas>
  <footer>ICU Management System - All Rights Reserved</footer>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const username = sessionStorage.getItem("username"); // ä¾‹å¦‚ D001 â†’ æ‹¿ä¾†æ¯”å°ç—…æ‚£
    const doctorName = sessionStorage.getItem("name");  // ä¾‹å¦‚ é»ƒé†«å¸« â†’ é¡¯ç¤ºåœ¨ç•«é¢å³ä¸Šè§’

    // âœ… åŠ å…¥é€™äº› log è§€å¯Ÿ sessionStorage æ˜¯å¦æ­£ç¢º
    console.log("ğŸš€ Dashboard è¼‰å…¥ä¸­...");
    console.log("ğŸ§¾ ç™»å…¥å¸³è™Ÿ username =", username);
    console.log("ğŸ§¾ é†«å¸«ä¸­æ–‡å doctorName =", doctorName);

    // å¦‚æœæœªç™»å…¥ï¼Œè½‰å› login é é¢
    if (!username) window.location.href = "login.html";

    // âœ… é¡¯ç¤ºé†«å¸«å§“å
    document.getElementById("doctor").innerText = doctorName || "æœªç™»å…¥";
    document.getElementById("now").innerText = new Date().toLocaleString();

    // âœ… é¡¯ç¤ºç›®å‰æ™‚é–“ï¼ˆæ¯ç§’æ›´æ–°ï¼‰
    function updateTime() {
     const now = new Date();
     document.getElementById("now").textContent = now.toLocaleString('zh-Hant-TW', {
       year: 'numeric', month: '2-digit', day: '2-digit',
       hour: '2-digit', minute: '2-digit', second: '2-digit'
     });
    }
    updateTime();
    setInterval(updateTime, 1000);


    fetch("https://icu-api-56bh.onrender.com/api/patients")
      .then(res => res.json())
      .then(data => {

        console.log("ğŸ“¦ ç—…æ‚£è³‡æ–™ç­†æ•¸ï¼š", data.length);
        console.log("ğŸ“‹ ç—…æ‚£è³‡æ–™å…§å®¹ï¼š", data);

        const body = document.querySelector("#patientTable tbody");
        let labels = [], scores = [];

        // âœ… æ¯”å°ç—…æ‚£è³‡æ–™ä¸­çš„ attending_doctor_id æ˜¯å¦ç­‰æ–¼ç™»å…¥çš„å¸³è™Ÿ
        data.forEach(p => {
	  console.log("ğŸ‘ æ­£åœ¨æ¯”å°ï¼šç—…æ‚£æ‰€å±¬é†«å¸« =", p.attending_doctor_id, "ç™»å…¥å¸³è™Ÿ =", username);

          if (p.attending_doctor_id === username){
            body.innerHTML += `<tr><td>${p.name}</td><td>${p.patient_id}</td><td>${p.age}</td><td>${p.gender}</td><td>${p.bed_id}</td><td>${p.diagnosis}</td><td>${p.apache_score}</td></tr>`;
            labels.push(p.name);
            scores.push(p.apache_score);
          }
        });

	// âœ… è‹¥ç„¡è³‡æ–™ï¼Œä¹Ÿé¡¯ç¤ºæç¤ºæ–‡å­—
	if (labels.length === 0) {
		body.innerHTML = `<tr><td colspan="7" style="text-align:center;">å°šç„¡æ‚¨è² è²¬çš„ç—…æ‚£è³‡æ–™</td></tr>`;
	}

	// âœ… ç•«åœ–è¡¨
        new Chart(document.getElementById("chart"), {
          type: 'bar',
          data: { 
            labels, 
	    datasets: [{ 
		label: "APACHE II", 
		data: scores 
            }] 
	  }
        });
      })

        
	.catch(err => {
		console.error("âŒ ç„¡æ³•å–å¾—ç—…æ‚£è³‡æ–™", err);
	document.querySelector("#patientTable tbody").innerHTML =
        	`<tr><td colspan="7" style="text-align:center;color:red;">âš  ç„¡æ³•å–å¾—ç—…æ‚£è³‡æ–™</td></tr>`;

	});

    function logout() {
      sessionStorage.clear();
      window.location.href = "login.html";
    }
  </script>
</body>
</html>
