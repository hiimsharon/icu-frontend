<!DOCTYPE html>

<html lang="zh-Hant">
<head>
<link href="style.css" rel="stylesheet"/>
<meta charset="utf-8"/>
<title>ICU ç—…æ‚£æŸ¥è©¢</title>
<style>
    body { font-family: sans-serif; padding: 0; margin: 0; }
    header { display: flex; justify-content: space-between; align-items: center; background: #f0f0f0; padding: 1em; }
    table { margin: 2em auto; border-collapse: collapse; width: 95%; }
    th, td { border: 1px solid #ccc; padding: 0.5em; }
    canvas { display: block; margin: 2em auto; }
    footer { margin-top: 2em; font-size: 0.8em; text-align: center; color: gray; }
    button.menu { margin-left: 1em; }
  </style>
</head>
<body>
<header>
<div><strong>ICU ç³»çµ±</strong> | <span id="now"></span></div>
<div>
      é†«å¸«ï¼š<span id="doctor"></span>
<button class="menu" onclick="window.location.href='form.html'">æ–°å¢è³‡æ–™</button>
<button class="menu" onclick="logout()">ç™»å‡º</button>
</div>
</header>

<div style="text-align: center; margin-top: 1em;">
<input id="searchInput" placeholder="ğŸ” æœå°‹ç—…æ‚£å§“å..." style="padding: 0.5em; width: 200px;" type="text"/>
<select id="sortSelect" style="padding: 0.5em;">
<option value="none">æ’åºæ–¹å¼</option>
<option value="apacheAsc">ä¾ APACHE åˆ†æ•¸ï¼ˆä½ â†’ é«˜ï¼‰</option>
<option value="apacheDesc">ä¾ APACHE åˆ†æ•¸ï¼ˆé«˜ â†’ ä½ï¼‰</option>
</select>
</div>
<table id="patientTable">
<thead>
<tr><th>å§“å</th><th>ç—…æ­·è™Ÿ</th><th>å¹´é½¡</th><th>æ€§åˆ¥</th><th>åºŠè™Ÿ</th><th>è¨ºæ–·</th><th>APACHE II</th></tr>
</thead>
<tbody></tbody>
</table>
<canvas height="200" id="chart" width="600"></canvas>
<footer>ICU Management System - All Rights Reserved</footer>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const doctor = sessionStorage.getItem("doctor");
if (!doctor) window.location.href = "login.html";
document.getElementById("doctor").innerText = doctor;
document.getElementById("now").innerText = new Date().toLocaleString();

let originalData = [];

function renderTable(data) {
  const body = document.querySelector("#patientTable tbody");
  body.innerHTML = "";
  let labels = [], scores = [];

  data.forEach(p => {
    if (p.attending_doctor_id === doctor) {
      body.innerHTML += `<tr><td>${p.name}</td><td>${p.patientID}</td><td>${p.age}</td><td>${p.gender}</td><td>${p.bedID}</td><td>${p.diagnosis}</td><td>${p.apache_score}</td></tr>`;
      labels.push(p.name);
      scores.push(p.apache_score);
    }
  });

  new Chart(document.getElementById("chart"), {
    type: 'bar',
    data: { labels, datasets: [{ label: "APACHE II", data: scores }] }
  });
}

fetch("https://icu-api-56bh.onrender.com/api/patients")
  .then(res => res.json())
  .then(data => {
    originalData = data;
    renderTable(data);
  });

document.getElementById("searchInput").addEventListener("input", function () {
  const keyword = this.value.toLowerCase();
  const filtered = originalData.filter(p => p.name.toLowerCase().includes(keyword));
  renderTable(filtered);
});

document.getElementById("sortSelect").addEventListener("change", function () {
  let sorted = [...originalData];
  if (this.value === "apacheAsc") {
    sorted.sort((a, b) => a.apache_score - b.apache_score);
  } else if (this.value === "apacheDesc") {
    sorted.sort((a, b) => b.apache_score - a.apache_score);
  }
  renderTable(sorted);
});

function logout() {
  sessionStorage.clear();
  window.location.href = "login.html";
}
</script>
</body>
</html>
